<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App H·ªçc Ti·∫øng Trung AI</title>
    {% load static %} {% csrf_token %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Hi·ªáu ·ª©ng bong b√≥ng chat */
      .chat-bubble {
        max-width: 80%;
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Thanh cu·ªôn ƒë·∫πp h∆°n */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
    </style>
  </head>
  <body
    class="bg-slate-100 h-screen flex flex-col items-center justify-center p-4"
  >
    <div
      class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[80vh]"
    >
      <div
        class="bg-gradient-to-r from-blue-600 to-indigo-700 p-5 text-white flex justify-between items-center shadow-md z-10"
      >
        <div>
          <h1 class="font-bold text-xl">üá®üá≥ Gia S∆∞ Ti·∫øng Trung AI</h1>
          <p class="text-xs text-blue-100 opacity-80">
            H·ªó tr·ª£ d·ªãch 2 chi·ªÅu & L∆∞u t·ª´ v·ª±ng t·ª± ƒë·ªông
          </p>
        </div>
        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
          <span class="text-xl">üéì</span>
        </div>
      </div>

      <div
        id="chat-box"
        class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50"
      >
        <div class="flex justify-start">
          <div
            class="chat-bubble bg-white border border-gray-200 text-gray-800 px-4 py-3 rounded-2xl rounded-tl-none shadow-sm"
          >
            Ch√†o T√∫! M√¨nh l√† tr·ª£ l√Ω ·∫£o. B·∫°n h√£y nh·∫≠p c√¢u ti·∫øng Vi·ªát ho·∫∑c ti·∫øng
            Trung, m√¨nh s·∫Ω d·ªãch v√† l∆∞u t·ª´ m·ªõi gi√∫p b·∫°n nh√©.
          </div>
        </div>
      </div>

      <div class="p-4 bg-white border-t border-gray-100">
        <div class="flex gap-3 relative">
          <input
            type="text"
            id="user-input"
            class="flex-1 bg-gray-100 border-0 rounded-xl px-5 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all shadow-inner"
            placeholder="Nh·∫≠p n·ªôi dung v√†o ƒë√¢y..."
            autocomplete="off"
          />

          <button
            onclick="sendMessage()"
            id="send-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg hover:shadow-blue-500/30 active:scale-95 flex items-center gap-2"
          >
            <span>G·ª≠i</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
          </button>
        </div>
        <div class="text-center mt-2 text-xs text-gray-400">
          Powered by Django & OpenAI
        </div>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");

      // L·∫•y CSRF token t·ª´ cookie
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1),
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // H√†m g·ª≠i tin nh·∫Øn
      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa User
        appendMessage("user", text);
        userInput.value = "";

        // Hi·ªáu ·ª©ng Loading
        const loadingId = showLoading();

        try {
          // 2. G·ªåI API DJANGO (Ph·∫ßn quan tr·ªçng nh·∫•t)
          const csrftoken = getCookie("csrftoken");
          const response = await fetch("/chat/chat/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ message: text }),
          });

          const data = await response.json();

          // X√≥a loading
          removeLoading(loadingId);

          // 3. Hi·ªÉn th·ªã ph·∫£n h·ªìi t·ª´ AI
          if (data.reply) {
            // Chuy·ªÉn k√Ω t·ª± xu·ªëng d√≤ng (\n) th√†nh th·∫ª <br> ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
            const formattedReply = data.reply.replace(/\n/g, "<br>");
            appendMessage("bot", formattedReply);
          } else {
            appendMessage("bot", "‚ö†Ô∏è C√≥ l·ªói x·∫£y ra, kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.");
          }
        } catch (error) {
          removeLoading(loadingId);
          appendMessage(
            "bot",
            `‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server: ${error.message}. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ ch·∫°y l·ªánh "python manage.py runserver".`,
          );
        }
      }

      // H√†m v·∫Ω bong b√≥ng chat
      function appendMessage(role, text) {
        const div = document.createElement("div");
        div.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;

        const bubbleColor =
          role === "user"
            ? "bg-blue-600 text-white rounded-tr-none"
            : "bg-white border border-gray-200 text-gray-800 rounded-tl-none";

        div.innerHTML = `
                <div class="chat-bubble ${bubbleColor} px-4 py-3 rounded-2xl shadow-sm break-words">
                    ${text}
                </div>
            `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; // T·ª± cu·ªôn xu·ªëng cu·ªëi
      }

      // Hi·ªáu ·ª©ng 3 ch·∫•m loading
      function showLoading() {
        const id = "loading-" + Date.now();
        const div = document.createElement("div");
        div.id = id;
        div.className = "flex justify-start";
        div.innerHTML = `
                <div class="bg-gray-100 px-4 py-3 rounded-2xl rounded-tl-none flex gap-1 items-center">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return id;
      }

      function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      // S·ª± ki·ªán nh·∫•n Enter ƒë·ªÉ g·ª≠i
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    </script>
  </body>
</html>
